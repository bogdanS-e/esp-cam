<!DOCTYPE html>
<html>

<head>
  <title>ESP32-CAM Car</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      overflow: auto;
      font-family: "Roboto", "Helvetica Neue", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      /* –¥–ª—è –±–æ–ª–µ–µ —á—ë—Ç–∫–∏—Ö –≥—Ä–∞–Ω–∏—Ü –Ω–∞ Android */
      -moz-osx-font-smoothing: grayscale;
      /* –¥–ª—è Firefox */
      text-rendering: optimizeLegibility;
      background-color: #121212;
      color: #E0E0E0;
      width: 100dvw;
      height: 100vh;
      position: relative;
    }

    button {
      background-color: #388E3C;
      border: none;
      outline: none;
      cursor: pointer;
    }

    button:focus,
    button:focus-within {
      border: none;
      outline: none;
    }

    button:active,
    button.active {
      background-color: #2E7D32;
    }

    button:disabled {
      background-color: #d3d3d3;
      cursor: auto;
      pointer-events: none;
    }

    #rotate-message {
      display: none;
      position: fixed;
      width: 100vw;
      height: 100vh;
      top: 0;
      left: 0;
      z-index: 3;
      background: inherit;
    }

    #rotate-message .content {
      display: flex;
      flex-direction: column;
      gap: 10px;
      justify-content: center;
      align-items: center;
      height: 100%;
      animation: rotate 2s 500ms forwards;
      font-size: 2rem;
    }

    #rotate-message svg {
      animation: rotate-infinite 3s infinite;
    }

    @keyframes rotate {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(90deg);
      }
    }

    @keyframes rotate-infinite {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    #status {
      padding: 5px;
      border-radius: 0 0 16px 16px;
      text-align: center;
      background: #388E3C;
      color: #fff;
      font-size: 0.75rem;
      position: fixed;
      z-index: 1;
      top: 0;
      left: 0;
      width: 100vw;
      transform: translateY(-100%);
      transition: transform 0.4s ease, opacity 0.4s ease;
      opacity: 0;
    }

    #status.visible {
      opacity: 1;
      transform: translateY(0);
    }

    #status.disconnected {
      background: #D32F2F;
    }

    #stream {
      display: block;
      border-radius: 16px;
      width: 100%;
      max-height: 100vh;
      object-fit: contain;
      background: transparent;
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
    }

    .joystick-wrapper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      padding: 10px 30px 20px;
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      z-index: 2;
    }

    .joystick {
      width: 150px;
      height: 100px;
      border-radius: 130px;
      background-color: #3a3a3a;
      display: flex;
      gap: 3px;
      padding: 3px;
      box-shadow: 0 0 20px #388E3C;
      transition: box-shadow 0.2s;
    }

    .joystick:has(button.active) {
      box-shadow: 0 0 40px #388E3C;
    }

    .joystick button {
      border: none;
      cursor: pointer;
      color: #fff;
      transition: transform 0.1s, background-color 0.2s;
    }

    .joystick button:active,
    .joystick button.active {
      transform: scale(0.8);
    }

    .joystick button:disabled {
      opacity: 0.4;
    }

    .joystick svg {
      width: 30px;
      height: 30px;
    }

    .joystick.horizontal button {
      width: 50%;
      height: 100%;
    }

    .joystick.vertical {
      flex-direction: column;
    }

    .joystick.vertical button {
      width: 100%;
      height: 50%;
    }

    #right {
      border-radius: 0 130px 130px 0;
    }

    #left {
      border-radius: 200px 0 0 200px;
    }

    #forward {
      border-radius: 130px 130px 0 0;
    }

    #backward {
      border-radius: 0 0 130px 130px;
    }

    #forward svg {
      transform: rotate(-90deg);
    }

    #backward svg {
      transform: rotate(90deg);
    }

    #left svg {
      transform: rotate(-180deg);
    }

    #toggle_flash {
      border-radius: 50%;
      position: absolute;
      bottom: 150px;
      right: 30px;
      padding: 15px;
      font-size: 1.5rem;
      z-index: 2;
    }

    #toggle_flash:active,
    #toggle_flash.active {
      background-color: #388E3C;
    }

    #toggle_flash.turned-off,
    #toggle_flash.turned-off:active,
    #toggle_flash.turned-off.active {
      background-color: #616161;
    }
  </style>
</head>

<body>
  <div id="rotate-message">
    <div class="content">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="50" height="50" x="0"
        y="0" viewBox="0 0 512 512">
        <g>
          <path
            d="m511.36 99.922-18.544 71.516a19.973 19.973 0 0 1-24.379 14.34L394.8 166.685a20 20 0 1 1 10.039-38.719l25.722 6.669C377.427 58.143 278.708 24.449 188.92 54.31a211.136 211.136 0 0 0-134 132.783 20 20 0 1 1-37.83-13A254.846 254.846 0 0 1 76.8 77.972a249.919 249.919 0 0 1 99.5-61.617A252.632 252.632 0 0 1 465.973 115.6l6.667-25.712a20 20 0 0 1 38.72 10.039zM482.5 312.49a20 20 0 0 0-25.413 12.417 211.136 211.136 0 0 1-134 132.783c-89.787 29.861-188.507-3.833-241.638-80.325l25.722 6.669a20 20 0 1 0 10.029-38.719l-73.64-19.093a20 20 0 0 0-24.379 14.34L.64 412.078a20 20 0 1 0 38.72 10.039l6.667-25.712A252.738 252.738 0 0 0 335.7 495.646a249.932 249.932 0 0 0 99.5-61.618 254.838 254.838 0 0 0 59.71-96.125 20 20 0 0 0-12.41-25.413z"
            fill="#fff"></path>
        </g>
      </svg>
      <div>–ü–æ–≤–µ—Ä–Ω–∏ —Ç–µ–ª–µ—Ñ–æ–Ω</div>
    </div>
  </div>

  <div class="disconnected" id="status">
    üî¥ Disconnected ‚ùå
  </div>

  <img id="stream" src="#">
  <button id="toggle_flash" class="turned-off controller">üî¶</button>
  <div class="joystick-wrapper">
    <div class="joystick vertical">
      <button class="controller movement-controller" id="forward">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 492.004 492.004">
          <path
            d="M382.678 226.804 163.73 7.86C158.666 2.792 151.906 0 144.698 0s-13.968 2.792-19.032 7.86l-16.124 16.12c-10.492 10.504-10.492 27.576 0 38.064L293.398 245.9l-184.06 184.06c-5.064 5.068-7.86 11.824-7.86 19.028 0 7.212 2.796 13.968 7.86 19.04l16.124 16.116c5.068 5.068 11.824 7.86 19.032 7.86s13.968-2.792 19.032-7.86L382.678 265c5.076-5.084 7.864-11.872 7.848-19.088.016-7.244-2.772-14.028-7.848-19.108z" />
        </svg>
      </button>
      <button class="controller movement-controller" id="backward">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 492.004 492.004">
          <path
            d="M382.678 226.804 163.73 7.86C158.666 2.792 151.906 0 144.698 0s-13.968 2.792-19.032 7.86l-16.124 16.12c-10.492 10.504-10.492 27.576 0 38.064L293.398 245.9l-184.06 184.06c-5.064 5.068-7.86 11.824-7.86 19.028 0 7.212 2.796 13.968 7.86 19.04l16.124 16.116c5.068 5.068 11.824 7.86 19.032 7.86s13.968-2.792 19.032-7.86L382.678 265c5.076-5.084 7.864-11.872 7.848-19.088.016-7.244-2.772-14.028-7.848-19.108z" />
        </svg>
      </button>
    </div>

    <div class="joystick horizontal">
      <button class="controller movement-controller" id="left">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 492.004 492.004">
          <path
            d="M382.678 226.804 163.73 7.86C158.666 2.792 151.906 0 144.698 0s-13.968 2.792-19.032 7.86l-16.124 16.12c-10.492 10.504-10.492 27.576 0 38.064L293.398 245.9l-184.06 184.06c-5.064 5.068-7.86 11.824-7.86 19.028 0 7.212 2.796 13.968 7.86 19.04l16.124 16.116c5.068 5.068 11.824 7.86 19.032 7.86s13.968-2.792 19.032-7.86L382.678 265c5.076-5.084 7.864-11.872 7.848-19.088.016-7.244-2.772-14.028-7.848-19.108z" />
        </svg>
      </button>
      <button class="controller movement-controller" id="right">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" wx="0" y="0"
          viewBox="0 0 492.004 492.004">
          <g>
            <path
              d="M382.678 226.804 163.73 7.86C158.666 2.792 151.906 0 144.698 0s-13.968 2.792-19.032 7.86l-16.124 16.12c-10.492 10.504-10.492 27.576 0 38.064L293.398 245.9l-184.06 184.06c-5.064 5.068-7.86 11.824-7.86 19.028 0 7.212 2.796 13.968 7.86 19.04l16.124 16.116c5.068 5.068 11.824 7.86 19.032 7.86s13.968-2.792 19.032-7.86L382.678 265c5.076-5.084 7.864-11.872 7.848-19.088.016-7.244-2.772-14.028-7.848-19.108z"
              fill="#000000"></path>
          </g>
        </svg>
      </button>
    </div>
  </div>
  <script>
    'use strict';
    var ws = null;
    var currentUrl = window.location.hostname;
    var statusElement = document.getElementById('status');
    var flashButton = document.getElementById("toggle_flash");

    function handleRotationScreen(params) {
      function checkOrientation() {
        const message = document.getElementById('rotate-message');

        if (window.matchMedia("(orientation: portrait)").matches) {
          message.style.display = "block";
        } else {
          message.style.display = "none";
        }
      }

      checkOrientation();
      window.addEventListener("resize", checkOrientation);
    }

    function showStatus(isConnected) {
      clearTimeout(statusElement._hideTimer);
      statusElement.classList.add("visible");

      if (isConnected) {
        statusElement.textContent = "üü¢ Connected ‚úÖ";
        statusElement.classList.remove("disconnected");

        // —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        statusElement._hideTimer = setTimeout(() => {
          statusElement.classList.remove("visible");
        }, 3000);

        return;
      }

      statusElement.textContent = "üî¥ Disconnected ‚ùå";
      statusElement.classList.add("disconnected");
    }


    function changeControls(disable) {
      //document.querySelectorAll('.controller').forEach(btn => btn.disabled = disable);
    }

    function handleWebSocket() {
      if (ws && ws.readyState === WebSocket.OPEN) return;

      ws = new WebSocket(`ws://${currentUrl}/ws`);

      let heartbeatInterval;
      let missedPongs = 0;
      const maxMissedPongs = 3;

      ws.onopen = function () {
        console.log('WebSocket connected');
        showStatus(true);
        changeControls(false);

        // –ó–∞–ø—É—Å–∫–∞–µ–º heartbeat
        heartbeatInterval = setInterval(() => {
          if (ws.readyState === WebSocket.OPEN) {
            ws.send('ping');
            missedPongs++;

            if (missedPongs >= maxMissedPongs) {
              console.log('Too many missed pongs, reconnecting...');
              ws.close();
            }
          }
        }, 5000); // –ü–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
      };

      ws.onmessage = function (event) {
        console.log('Received:', event.data);

        if (event.data === 'pong') {
          missedPongs = 0; // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞
          return;
        }

        if (event.data.startsWith("Flash-")) {
          const state = event.data.split("-")[1];

          if (state === "ON") {
            flashButton.classList.remove("turned-off");
          } else if (state === "OFF") {
            flashButton.classList.add("turned-off");
          }
        }
      };

      ws.onclose = function () {
        console.log('WebSocket disconnected');
        showStatus(false);
        changeControls(true);
        clearInterval(heartbeatInterval);
        setTimeout(handleWebSocket, 2000);
      };

      ws.onerror = function (error) {
        console.log('WebSocket error:', error);
        clearInterval(heartbeatInterval);
      };
    }

    function sendData(data) {
      console.log(data);

      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(data);
      }
    }

    function handleMovement() {
      const DATA_SEND_INTERVAL = 100;
      const controllers = document.querySelectorAll('.movement-controller');
      const intervals = {};
      const activeKeys = new Set();

      function startAction(elementId) {
        if (intervals[elementId]) return;

        activeKeys.add(elementId);

        const activeElement = document.getElementById(elementId);

        if (activeElement) {
          activeElement.classList.add("active");
        }

        handleDirection();

        intervals[elementId] = setTimeout(function repeat() {
          handleDirection();
          intervals[elementId] = setTimeout(repeat, DATA_SEND_INTERVAL);
        }, DATA_SEND_INTERVAL);
      }

      function stopAction(elementId) {
        if (!intervals[elementId]) {
          return;
        }

        activeKeys.delete(elementId);

        const activeElement = document.getElementById(elementId);

        if (activeElement) {
          activeElement.classList.remove("active");
        }

        clearTimeout(intervals[elementId]);
        delete intervals[elementId];

        handleDirection();
      }

      function handleDirection() {
        const dirs = Array.from(activeKeys);
        let output = "";

        if (dirs.length === 1) {
          output = dirs[0];
        } else if (dirs.length === 2) {
          const x = dirs.find(d => d === "forward" || d === "backward");
          const y = dirs.find(d => d === "left" || d === "right");

          if (x && y) output = `${x}-${y}`;
        }

        if (output) {
          sendData(output);

          return
        }

        sendData("stop");
      }

      // mouse
      controllers.forEach(elementId => {
        elementId.addEventListener("mousedown", () => startAction(elementId.id));
        elementId.addEventListener("mouseup", () => stopAction(elementId.id));
        elementId.addEventListener("mouseleave", () => stopAction(elementId.id));
      });

      // keyboard
      const keyMap = { w: "forward", s: "backward", a: "left", d: "right" };
      document.addEventListener("keydown", e => {
        const elementId = keyMap[e.key.toLowerCase()];
        if (elementId) startAction(elementId);
      });
      document.addEventListener("keyup", e => {
        const elementId = keyMap[e.key.toLowerCase()];
        if (elementId) stopAction(elementId);
      });

      // multitouch
      const joystickWrapper = document.querySelector(".joystick-wrapper");
      joystickWrapper.addEventListener("touchstart", e => {
        e.preventDefault();

        for (const { target } of e.changedTouches) {
          const controller = target.closest(".movement-controller");

          if (controller) {
            startAction(controller.id);
          }
        }
      });
      joystickWrapper.addEventListener("touchend", e => {
        e.preventDefault();
        for (const { target } of e.changedTouches) {
          const controller = target.closest(".movement-controller");

          if (controller) {
            stopAction(controller.id);
          }
        }
      });
      joystickWrapper.addEventListener("touchcancel", e => {
        e.preventDefault();
        for (const { target } of e.changedTouches) {
          const controller = target.closest(".movement-controller");

          if (controller) {
            stopAction(controller.id);
          }
        }
      });
    }

    function handleFunctions() {

      flashButton.addEventListener("click", function () {
        sendData("toggle_flash");
      });
    }

    function startStreaming() {
      var streamElement = document.getElementById('stream');

      streamElement.src = `http://${currentUrl}:81/stream`;
    }

    document.addEventListener("DOMContentLoaded", function () {
      changeControls(true);
      handleRotationScreen();
      handleWebSocket();
      handleMovement();
      startStreaming();
      handleFunctions();
    });
  </script>
</body>

</html>